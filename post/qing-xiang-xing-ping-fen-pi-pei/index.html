<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>倾向性评分匹配 | Zhu Min</title>
<link rel="shortcut icon" href="https://kokomole.github.io/favicon.ico?v=1585339899335">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://kokomole.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="倾向性评分匹配 | Zhu Min - Atom Feed" href="https://kokomole.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="临床上收集的回顾性数据，由于无法随机化，所以组间均衡性比较差。为了消除混杂因素对患者基线的影响，我们可以采用以下处理方法：多元回归模型调整、倾向性评分匹配（PSM）、 回归模型调整倾向性评分（PS）、回归模型+加权（IPTW）处理、回归模型..." />
    <meta name="keywords" content="test" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://kokomole.github.io">
  <img class="avatar" src="https://kokomole.github.io/images/avatar.png?v=1585339899335" alt="">
  </a>
  <h1 class="site-title">
    Zhu Min
  </h1>
  <p class="site-description">
    所有年轻的过客，都赞叹太空的辽阔
  </p>
  <div class="menu-container">
    
      
        <a href="/post/home" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              倾向性评分匹配
            </h2>
            <div class="post-info">
              <span>
                2020-03-28
              </span>
              <span>
                9 min read
              </span>
              
                <a href="https://kokomole.github.io/tag/7pPjdpyI8/" class="post-tag">
                  # test
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <p>临床上收集的回顾性数据，由于无法随机化，所以组间均衡性比较差。为了消除混杂因素对患者基线的影响，我们可以采用以下处理方法：多元回归模型调整、倾向性评分匹配（PSM）、 回归模型调整倾向性评分（PS）、回归模型+加权（IPTW）处理、回归模型+加权（SMR）处理等。</p>
<p>本文使用的方法是倾向性评分匹配（PSM）。</p>
<hr>
<p>#PSM的定义</p>
<blockquote>
<p>倾向性评分匹配：</p>
<p>用一定的统计学方法对实验组与对照组进行筛选，使筛选出来的对象在临床特征上具有可比性。经过这样的处理后，组间的结局存在差异，就可以完全归结于暴露因素的影响了。</p>
</blockquote>
<figure data-type="image" tabindex="1"><img src="https://upload-images.jianshu.io/upload_images/13970747-3d319e8183dbb0cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500" alt="PSM示意图" loading="lazy"></figure>
<hr>
<p>#PSM的原理<br>
设对象<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>的分组结果为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>（<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Z_i=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>时为实验组，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">Z_i=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>时为对照组），则在给定一组变量<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>（混杂因素）条件下，将任意一个对象<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi><mo>(</mo><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><mi>N</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">i(i=1,2,\cdots,N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">i</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>划分到实验组（<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Z_i=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>）的条件概率为：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>e</mi><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>)</mo><mo>=</mo><mi>p</mi><mo>(</mo><msub><mi>Z</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo>∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">e(x_i)=p(Z_i =1\mid x_i)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>我们可以将各个混杂因素（自变量）与分组结果（因变量）联系起来。由于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>e</mi><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">e(x_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>的取值在0~1之间，因此需要对它做logit变换：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>n</mi><mfrac><mrow><mi>e</mi><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>)</mo></mrow><mrow><mn>1</mn><mo>−</mo><mi>e</mi><mo>(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>)</mo></mrow></mfrac><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mo>⋯</mo><mo>+</mo><msub><mi>β</mi><mi>m</mi></msub><msub><mi>x</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">ln\frac{e(x_i)}{1-e(x_i)}=\beta_0+\beta_1x_1+\cdots+\beta_mx_m
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>对于对照组的患者，我们同样会计算评分。然后将评分（入选概率）接近的患者进行匹配。</p>
<p>#PSM的过程<br>
![倾向性评分的步骤](https://upload-images.jianshu.io/upload_images/13970747-9a59391037db9e30.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/3</p>
<!-- more -->
<!-- more -->
<!-- more -->
<ol start="0">
<li></li>
</ol>
<p>匹配算法有：最近匹配（NNM）、卡钳匹配（CM）、马氏距离匹配（MMM）、Radius匹配等。</p>
<blockquote>
<p>最近匹配的步骤：</p>
<ol>
<li>对于处理组中的每个个体，在对照组中寻找与其倾向性评分最接近的个体进行匹配</li>
<li>若对照组中有2个或以上的匹配个体，则随机选取</li>
<li>剔除匹配成功的个体</li>
<li>重复以上步骤</li>
</ol>
<p>卡钳匹配：</p>
<ul>
<li>在最近匹配的基础上增加一个限制条件，两个个体的倾向性评分差值在事先设定的范围（卡钳值）内才能进行匹配</li>
<li>卡钳值越大，匹配的对越多，但组间均衡性变差</li>
</ul>
</blockquote>
<hr>
<p>#PSM在R中的实现</p>
<p>##R包与数据集<br>
我们使用的R包为<code>MatchIt</code>，它自带数据集<code>lalonde</code>。该数据集共有10变量，614个观测，其中治疗组有185人，控制组有429人。10个变量分别为：</p>
<ol>
<li><code>treat</code>：治疗方案 (1=treated, 0=control)；</li>
<li><code>age</code>：年龄，单位是年；</li>
<li><code>educ</code>：接受教育的时长，单位是年；</li>
<li><code>black</code>：是否为非洲裔 (1=African-American, 0=not)；</li>
<li><code>hispan</code>：是否为拉丁美裔 (1=Hispanic, 0=not)；</li>
<li><code>married</code>：是否已婚 (1=married, 0=not married)；</li>
<li><code>nodegred</code>：是否有高中学历 (1=no degree, 0=degree)；</li>
<li><code>re74</code>：患者在1974年的收入，单位是美元；</li>
<li><code>re75</code>：患者在1975年的收入，单位是美元；</li>
<li><code>re78</code>：患者在1978年的收入，单位是美元；</li>
</ol>
<pre><code>&gt; library(MatchIt)
&gt; data(lalonde)
&gt; head(lalonde)
     treat age educ black hispan married nodegree re74 re75       re78
NSW1     1  37   11     1      0       1        1    0    0  9930.0460
NSW2     1  22    9     0      1       0        1    0    0  3595.8940
NSW3     1  30   12     1      0       0        0    0    0 24909.4500
NSW4     1  27   11     1      0       0        1    0    0  7506.1460
NSW5     1  33    8     1      0       0        1    0    0   289.7899
NSW6     1  22    9     1      0       0        1    0    0  4056.4940
</code></pre>
<p>以上10个变量中，<code>treat</code>是我们分组因素，剩下的9个属于临床混杂因素，会干扰不同患者的基线水平，它们中有些是显著的，有些是不显著的。</p>
<p>##PSM匹配<br>
对于<code>lalonde</code>数据集，我们认为如果直接按<code>treat</code>分组，两组的组间不均衡，所以考虑根据后面的混杂因素对患者进行打分，得分接近的患者才会入组。这样的做法是牺牲一部分的样本量来提高组间均衡性。</p>
<pre><code>lalonde_match&lt;-matchit(data = lalonde,
                       treat~age+educ+black+hispan+married+nodegree+re74+re75+re78,
                       method = &quot;nearest&quot;,
                       distance = &quot;logit&quot;,
                       ratio=1,
                       caliper=0.1)
</code></pre>
<p>以上过程中，我们使用的是匹配算法是最近匹配（卡钳值为0.1），匹配比例为1:1匹配（一个治疗组患者对应一个控制组患者），得分与入组概率之间的链接函数是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">logit</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span></span></span></span>变换。</p>
<p>##匹配结果</p>
<pre><code>&gt; summary(lalonde_match)

Call:
matchit(formula = treat ~ age + educ + black + hispan + married + 
    nodegree + re74 + re75 + re78, data = lalonde, method = &quot;nearest&quot;, 
    distance = &quot;logit&quot;, ratio = 1, caliper = 0.1)

Summary of balance for all data:
         Means Treated Means Control SD Control  Mean Diff   eQQ Med  eQQ Mean    eQQ Max
distance        0.5802        0.1810     0.2292     0.3991    0.5043    0.3995     0.6051
age            25.8162       28.0303    10.7867    -2.2141    1.0000    3.2649    10.0000
educ           10.3459       10.2354     2.8552     0.1105    1.0000    0.7027     4.0000
black           0.8432        0.2028     0.4026     0.6404    1.0000    0.6432     1.0000
hispan          0.0595        0.1422     0.3497    -0.0827    0.0000    0.0811     1.0000
married         0.1892        0.5128     0.5004    -0.3236    0.0000    0.3243     1.0000
nodegree        0.7081        0.5967     0.4911     0.1114    0.0000    0.1135     1.0000
re74         2095.5737     5619.2365  6788.7508 -3523.6628 2425.5720 3620.9240  9216.5000
re75         1532.0553     2466.4844  3291.9962  -934.4291  981.0968 1060.6582  6795.0100
re78         6349.1435     6984.1697  7294.1618  -635.0262  475.8090 1248.1867 34743.2600


Summary of balance for matched data:
         Means Treated Means Control SD Control Mean Diff  eQQ Med  eQQ Mean    eQQ Max
distance        0.5104        0.4921     0.2431    0.0184   0.0238    0.0200     0.0291
age            26.2411       25.4018    10.2847    0.8393   4.0000    3.5357     8.0000
educ           10.4643       10.3393     2.8110    0.1250   0.0000    0.5536     3.0000
black           0.7411        0.7411     0.4400    0.0000   0.0000    0.0000     0.0000
hispan          0.0982        0.0625     0.2431    0.0357   0.0000    0.0357     1.0000
married         0.2411        0.2321     0.4241    0.0089   0.0000    0.0089     1.0000
nodegree        0.6607        0.6339     0.4839    0.0268   0.0000    0.0268     1.0000
re74         2501.2724     2438.5350  4484.2756   62.7374 109.1653  546.2933 13121.7500
re75         1748.2418     1742.7191  2833.9692    5.5227 205.8871  465.4185 11365.7100
re78         6292.8371     5950.4090  6367.6951  342.4281 563.7596 1006.6540 16403.5700

Percent Balance Improvement:
         Mean Diff.   eQQ Med eQQ Mean  eQQ Max
distance    95.4020   95.2706  95.0014  95.1953
age         62.0934 -300.0000  -8.2959  20.0000
educ       -13.1071  100.0000  21.2225  25.0000
black      100.0000  100.0000 100.0000 100.0000
hispan      56.8312    0.0000  55.9524   0.0000
married     97.2411    0.0000  97.2470   0.0000
nodegree    75.9492    0.0000  76.4031   0.0000
re74        98.2195   95.4994  84.9129 -42.3724
re75        99.4090   79.0146  56.1198 -67.2655
re78        46.0765  -18.4844  19.3507  52.7863

Sample sizes:
          Control Treated
All           429     185
Matched       112     112
Unmatched     317      73
Discarded       0       0
</code></pre>
<p>可以发现185个接受治疗的患者中，有112个入选治疗组；429个空白对照的患者中，有112个入选控制组。所以这224个患者是试验的最终入选结果，此时两组的均衡性应该相当好。</p>
<p>##匹配结果的可视化<br>
###匹配前后倾向值评分的分布图<br>
用鼠标点击图中的点会显示出该点所对应的患者ID。</p>
<pre><code>&gt; plot(lalonde_match, type = &quot;jitter&quot;) 
[1] &quot;To identify the units, use first mouse button; to stop, use second.&quot;
[1] 139
</code></pre>
<p><img src="https://upload-images.jianshu.io/upload_images/13970747-9c410d5d7ea66833.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500" alt="匹配前后倾向值评分的分布图" loading="lazy"><br>
###匹配前后倾向值评分的直方图</p>
<pre><code>&gt; plot(lalonde_match, type = &quot;hist&quot;) 
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://upload-images.jianshu.io/upload_images/13970747-25beb008db891f15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500" alt="匹配前后倾向值评分的直方图" loading="lazy"></figure>

              </div>
              <div class="toc-container">
                
              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://kokomole.github.io/post/ce-shi/">
              <h3 class="post-title">
                测试
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://kokomole.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
